generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Event {
  id             String           @id @default(cuid())
  organizerId    String
  organizer      OrganizerProfile @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  userId         Int?
  user           Users?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  title          String
  description    String?
  category       String?
  location       String
  startAt        DateTime
  endAt          DateTime
  isPaid         Boolean          @default(false)
  capacity       Int
  seatsAvailable Int

  ticketTypes TicketType[]
  promotions  Promotion[]
  tickets     Ticket[]
  reviews     Review[]
  Transaction Transaction[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Voucher   Voucher[]

  @@index([startAt])
  @@index([category])
  @@index([location])
}

model TicketType {
  id              String            @id @default(cuid())
  eventId         String
  event           Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name            String
  priceIDR        Int
  quota           Int?
  createdAt       DateTime          @default(now())
  TransactionItem TransactionItem[]
  Ticket          Ticket[]
}

model Promotion {
  id          String   @id @default(cuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  code        String
  type        String // "PERCENT" | "FLAT"
  value       Int
  minSpendIDR Int      @default(0)
  startsAt    DateTime
  endsAt      DateTime
  maxUses     Int?
  usedCount   Int      @default(0)

  @@unique([eventId, code])
}

model OrganizerProfile {
  id           String  @id @default(cuid())
  userId       Int     @unique
  user         Users   @relation(fields: [userId], references: [id], onDelete: Cascade)
  displayName  String
  bio          String?
  events       Event[]
  ratingsAvg   Float   @default(0)
  ratingsCount Int     @default(0)
}

model Voucher {
  id            String   @id @default(uuid())
  discount      Float
  name          String
  event_id      String
  expiry_date   DateTime
  code          String   @unique
  max_usage     Int
  current_usage Int
  event         Event    @relation(fields: [event_id], references: [id])
  is_active     Boolean  @default(true)
}

model Review {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    Int
  user      Users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  @@unique([eventId, userId])
}

model Coupon {
  name                String
  expiry_date         DateTime
  code                String     @unique
  max_usage           Int
  current_usage       Int        @default(0)
  description         String?
  is_used             Boolean    @default(false)
  user_id             Int
  discount_percentage Int
  id                  Int        @id @default(autoincrement())
  creatAt             DateTime   @default(now())
  user                Users      @relation(fields: [user_id], references: [id])
  Referral            Referral[]
}

model Users {
  first_name          String
  last_name           String
  profile_picture     String?
  password            String               @db.VarChar(255)
  email               String               @unique
  referral_code       String               @unique @db.VarChar(30)
  user_points         Int                  @default(0)
  roleId              Int                  @default(1)
  is_verified         Boolean              @default(false)
  expiry_points       DateTime
  id                  Int                  @id @default(autoincrement())
  referred_by         Int?
  discount_coupons    Coupon[]
  event               Event[]
  passwordResetTokens PasswordResetToken[]
  PointTransactions   PointTransactions[]
  reviews             Review[]
  Transactions        Transaction[]
  referralsGiven      Referral[]           @relation("ReferralsGiven")
  referralsReceived   Referral?            @relation("ReferralsReceived")
  referredUser        Users?               @relation("UserReferrals", fields: [referred_by], references: [id])
  referredUsers       Users[]              @relation("UserReferrals")
  organizerProfile    OrganizerProfile?
  role                Role                 @relation(fields: [roleId], references: [id])

  @@index([referred_by])
  @@map("users")
}

// schema.prisma
model Transaction {
  id               String            @id @default(cuid())
  userId           Int
  user             Users             @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId          String
  event            Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  status           TxStatus          @default(WAITING_PAYMENT)
  totalBeforeIDR   Int
  pointsUsedIDR    Int               @default(0)
  promoCode        String?
  promoDiscountIDR Int               @default(0)
  totalPayableIDR  Int
  paymentProofUrl  String?
  paymentProofAt   DateTime?
  expiresAt        DateTime // createdAt + 2h
  decisionDueAt    DateTime? // paymentProofAt + 3d
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  items            TransactionItem[]
  tickets          Ticket[]

  @@index([status])
  @@index([expiresAt])
  @@index([decisionDueAt])
}

model TransactionItem {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  ticketTypeId  String?
  ticketType    TicketType? @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)
  qty           Int
  unitPriceIDR  Int
  lineTotalIDR  Int
}

model Ticket {
  id            String      @id @default(cuid())
  eventId       String
  event         Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  ticketTypeId  String?
  ticketType    TicketType? @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)
  ownerUserId   String?
  checkedInAt   DateTime?
  createdAt     DateTime    @default(now())
}

model PointTransactions {
  id          Int      @id @default(autoincrement())
  userId      Int
  amount      Int
  type        String
  description String?
  CreatedAt   DateTime @default(now())
  expiry_date DateTime
  is_expired  Boolean  @default(false)
  user        Users    @relation(fields: [userId], references: [id])

  @@index([userId, is_expired])
  @@index([expiry_date])
}

model Role {
  id   Int     @id @default(autoincrement())
  name String
  user Users[]
}

model Referral {
  id                      Int            @id @default(autoincrement())
  referral_code_used      String         @db.VarChar(30)
  status                  RefferalStatus @default(pending)
  referrer_points_awarded Int            @default(10000)
  created_at              DateTime       @default(now())
  completed_at            DateTime?
  referred_by             Int
  referred_user           Int            @unique
  referral_coupon_id      Int
  coupon                  Coupon         @relation(fields: [referral_coupon_id], references: [id])
  referred_by_user        Users          @relation("ReferralsGiven", fields: [referred_by], references: [id])
  referred_User           Users          @relation("ReferralsReceived", fields: [referred_user], references: [id])

  @@index([referral_code_used])
  @@map("referral")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      Users    @relation(fields: [userId], references: [id])
}

enum TxStatus {
  WAITING_PAYMENT
  WAITING_CONFIRMATION
  DONE
  REJECTED
  EXPIRED
  CANCELED
}

enum RefferalStatus {
  pending
  completed
  expired
}
